<html>
	<head>
		<title>Master Notes Collaboration</title>
		
		<link rel="stylesheet" href="MNC_chat.css">
		
		<style>
			.view {
				border:1px solid red;
			}
			
			textarea#log{
				width:100%;
				height:100%;
			}
			
			.hide{
				display:none;
			}
		</style>
		
	</head>
	
	<body style="font-family:TimesNewRoman!" id="body">

		<script>
		window.onload = function(){
		
		
		var ui_logout = document.getElementById("logout");
		var ui_login = document.getElementById("login");
		var ui_container = document.getElementById("container");
		var ui_loginSubmit = document.getElementById("loginSubmit");
		
		// if logged_in cookie not set - show log in screen
		check_auth();
		
		

		
		
		function login_setup(){
			console.log('you are logged in');
			//document.getElementById('container').className = '';
			ui_container.classList.remove("hide");
			
			document.getElementById('login').classList.add("hide");
			document.getElementById('logout').classList.remove("hide");		
		}
		
		function logout(){
			ui_logout.classList.add("hide");
			ui_login.classList.remove("hide");
			ui_container.classList.add("hide");
			document.cookie = "logged_in=0";
		}
		
		function check_auth(){
			console.log('check_auth');
			var logged_in = getCookie("logged_in");
			console.log(logged_in);
			
			if(logged_in !='bf44550db31d8f59b5da10e3a00a5072a481810b0dadfc6cfcc1f948b5f170f8') // not logged in
			{
				console.log('you are not logged in');
				// show login page
			
				//ui_container.classList.remove('hide');
				ui_container.classList.add('hide');
			}
			else // logged in
			{
				login_setup();

				getChatFromDB();
				
			}
		}
	
	
		
		
		ui_loginSubmit.onclick = function(){
			console.log('you clicked submit');
			
			var user = document.getElementById("loginUser").value;
			var pass = document.getElementById("loginPass").value;
			
			console.log(pass);
			
			getAuth(user, pass);
			check_auth();
			
		};
		
		
		////////////////////////////////////
		// CHAT AREA
		////////////////////////////////////
		
		// when the submit button is hit
		document.getElementById("submit").onclick = function(){
			sendString();
			getChatFromDB();
		}
		
		// when enter is pressed
		var textbox = document.getElementById("textbox");
		
		textbox.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
		   event.preventDefault();
		   sendString();
		   //document.getElementById("myBtn").click();
		  }
		});
		
		// Logout
		ui_logout.onclick = function(){
			logout();		
		};
		
		
		// reload chat
		document.getElementById("reload").onclick = function(){		
			//alert('reload clicked');
			getChatFromDB();
		};
	
		
		function sendString(){	
		
			var textbox = document.getElementById("textbox");  // this references the textbox OBJECT
			var savestring = textbox.value; // this is getting the value of the textbox
			
			//console.log(savestring);
			if(savestring!="")
				{
				var username = getCookie("user");
				// the updated save string [user] + savestring
				savestring = "["+username+"]: " + savestring; 
				
				// save the chat string
				saveToDB(savestring, getChatFromDB);
				

				// get saved chat to enter into thelog
				// returned_log 
				//getChatFromDB();
				
				
				// update the chat log
				//var thelog = document.getElementById("log");
				
				//console.log('the log 54')
				//console.log(thelog);
				//alert(thelog);
				//console.log(thelog.value);
				

				//console.log(thelog);
				
				// set the textbox to empty
				textbox.value = "";	
				}
			
		}
			
		function saveToDB(savestring, onSuccess) {
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("demo").innerHTML = this.responseText;
			  //console.log(this.responseText);
			  onSuccess();
			}
		  };
		  
		  var apikey = getCookie("logged_in");
		  var poststring = "action=save&savestring=" + savestring + "&apikey=" + apikey;
		  console.log(poststring);
		  xhttp.open("POST", "chat.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		  console.log('saved to db');
		  
		  
		}			
			
		function getChatFromDB() {
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("log").innerHTML = this.responseText; // this.responseText should be from python
			  //console.log(this.responseText);
			  var responses = JSON.parse(this.responseText);
			  //console.log('js responses: ');
			  //console.log(responses);
			  //console.log(typeof(responses));
			  //console.log(responses[0][0]);
			  //responses.forEach()
			  
			  var formatted_chatlog = '';
			  
			  for(i=0; i<responses.length; i++)
			  {
				//console.log(responses[i]["ID"]);
				formatted_chatlog = formatted_chatlog + responses[i]["date"] + " " + responses[i]["chatstring"] + "\n";
				
			  }
			  
			  document.getElementById("log").innerHTML = formatted_chatlog; // this.responseText should be from python
			  
			}
		  };
		  
		  console.log(getCookie("logged_in"));
		  var poststring = "action=getchat&apikey=" + getCookie("logged_in");
		  //console.log(poststring);
		  xhttp.open("POST", "chat.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		}	
			
		function getAuth(user, pass) {
			console.log('getAuth');
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				// what to do if this request works
				
			  console.log(this.responseText);
			  var responses = JSON.parse(this.responseText); //  use if response is json
			  //var responses = this.responseText;
			  console.log('js responses: ');
			  console.log(responses.user);
			  //console.log(typeof(responses));
			  //console.log(responses[0][0]);
			  //responses.forEach()
			  
			// set cookie
			document.cookie = 'logged_in=' + responses.apikey;
			document.cookie = 'user=' + responses.user;
			console.log(document.cookie);
			
			//document.cookie = "expires=Thu, 01 Jan 1970 00:00:00 UTC;";
			
			console.log(document.cookie);
			
			var logged_in = getCookie("logged_in");
			check_auth(logged_in);
			
			// change hide settings
			
			// load chat
			
			
			// to streamline, make this into a callable function
			  
			}
		  };
		  
		  var poststring = "user=" + user + "&pass=" + pass;
		  console.log(poststring);
		  xhttp.open("POST", "auth.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		}	
		
		// if any radio buttons are pressed
		document.getElementById("modeDefault").addEventListener("change", set_mode);
		document.getElementById("modeDark").addEventListener("change", set_mode);
		document.getElementById("modeMo").addEventListener("change", set_mode);
		
		// find which one is pressed/active
		
		function tell_me_the_mode() { 
            var ele = document.getElementsByName('mode'); 
              
            for(i = 0; i < ele.length; i++) { 
                if(ele[i].checked) 
				{
					var mode = ele[i].id;

				}
            } 
			
			return mode;
			//console.log(mode);
        } 
		
		// set the body class to the appropriate mode


		function set_mode()
		{	
			var mode = tell_me_the_mode();
			
			if(mode=="modeDark")
			{
				var modeClass = "dark";
			}
			
			if(mode=="modeMo")
			{
				var modeClass = "mo";
			}

			if(mode=="modeDefault")
			{
				var modeClass = "";
			}			
			
			var ele = document.getElementById("body");
			
			//remove class name from body
			ele.className = '';
			
			
			//add class name to body
			
			ele.classList.add(modeClass);
			
			//console.log(mode);
			//document.getElementById.

			
			
			
		}
		
		function testApi()
		{
		var xhttp = new XMLHttpRequest();
		
		// run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("demo").innerHTML = this.responseText;
			  //console.log('api response: ');
			  //console.log(this.responseText);
			  //onSuccess();
			}
		  };
		  
		  var poststring = "action=save&savestring=" + 'this is a test' + '&apikey=12';
		  xhttp.open("POST", "chat.php", true); // post
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring); // post
		  
		  
		  /*
		  xhttp.open("GET", "chat.php?action=test", true);
		  xhttp.send();
		  console.log('saved to db');
		  */
		  
		}
		
		function getCookie(cname) {
			  var name = cname + "=";
			  var decodedCookie = decodeURIComponent(document.cookie);
			  var ca = decodedCookie.split(';');
			  for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
				  c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
				  return c.substring(name.length, c.length);
				}
			  }
			  return "";
			}
		}
		</script>
		<div id="container" class="hide">
			<div style="width:60%; margin-left:20%" class="view">
					<h1 style="text-align:center;font-size:75" title="this site was made by reese">Master Notes Collaboration</h1>
					
					<!make the version history a subdomain>
					<p style="font-size:24;text-align:center;"><a href="https://tinyurl.com/yawp86zd" >MNC Version 11</a></p>
					<hr>
				
					<input type="button" style="font-size:20;height:75;width:225;"value=Chat>
					<input type="button" style="font-size:20;height:75;width:225;"value=Status>
					<input type="button" style="font-size:20;height:75;width:225;"value=Profile>	
					<input type="image" id="reload" width="50" height="50" src="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9JzMwMHB4JyB3aWR0aD0nMzAwcHgnICBmaWxsPSIjMDAwMDAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWw6c3BhY2U9InByZXNlcnZlIiB2ZXJzaW9uPSIxLjEiIHN0eWxlPSJzaGFwZS1yZW5kZXJpbmc6Z2VvbWV0cmljUHJlY2lzaW9uO3RleHQtcmVuZGVyaW5nOmdlb21ldHJpY1ByZWNpc2lvbjtpbWFnZS1yZW5kZXJpbmc6b3B0aW1pemVRdWFsaXR5OyIgdmlld0JveD0iMCAwIDEwMDAwMCAxMDAwMDAiIHg9IjBweCIgeT0iMHB4IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCI+PGRlZnM+PHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAgCiAgICAuZmlsMCB7ZmlsbDojMDAwMDAwO2ZpbGwtcnVsZTpub256ZXJvfQogICAKICA8L3N0eWxlPjwvZGVmcz48Zz48cGF0aCBjbGFzcz0iZmlsMCIgZD0iTTQ1MjQwIDE0NzE4YzE0OTc3LDAgMjc4MDYsOTM4NyAzMjkxNSwyMjU4NGwxMTg4OCAwIC04NzIyIDkwODEgLTg3MjMgOTA3OCAtODcyMiAtOTA4MSAtODcyMiAtOTA3OCAxMTUxNyAwYy00MzMxLC03MzExIC0xMjI5NiwtMTIxOTcgLTIxNDMxLC0xMjE5NyAtMTM3NjMsMCAtMjQ4OTUsMTExMzAgLTI0ODk1LDI0ODk1IDAsMTM3NTEgMTExNDMsMjQ4OTQgMjQ4OTUsMjQ4OTQgOTE1NCwwIDE3MTQyLC00OTIzIDIxNDY2LC0xMjI3MGwxMTQ4MSAwYy01MDg2LDEzMjQxIC0xNzkzMSwyMjY1NyAtMzI5NDcsMjI2NTcgLTE5NDgwLDAgLTM1MjgyLC0xNTgwMiAtMzUyODIsLTM1MjgxIDAsLTE5NDY1IDE1ODE2LC0zNTI4MiAzNTI4MiwtMzUyODJ6Ij48L3BhdGg+PC9nPjwvc3ZnPg" />
			<!resize image>
				
					<textarea id="log" name="chatlog" readonly style="left:400;top:279;"></textarea>
					<input type="text" id="textbox" class="form" name="textbox" placeholder="Type something..." size="140" style="height:29;left:400;top:790;"/>
					<input type="submit" id="submit" style="font-size:20;width:90;right:414;top:790;"/>
				
				
				<div>
					<label><input type="radio" name="mode" id="modeDefault" checked value="Default mode">Default mode</label><br>
					<label><input type="radio" name="mode" id="modeDark" value="Dark mode">Dark mode</label><br>
					<label><input type="radio" name="mode" id="modeMo" value="Mo(de)">Mo(de)<label><br>
				</div>
			</div>	
		</div>
		
		<div id="login" class="">
			Username: <input type="text" id="loginUser">
			Password: <input type="text" id="loginPass">
			<input type="submit" value="Submit" id="loginSubmit" name="submit">
		</div>
		
		<div id="logout">
			<button id="logout">Logout</button>
		</div>
			
<!style="background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAIUlEQVQoU2NkIBIwEqmOAVnhfwYGFD6KGWSZiNcVw8pEAEZ0AQuafugDAAAAAElFTkSuQmCC');">