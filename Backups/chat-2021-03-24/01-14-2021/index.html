<html>
	<head>
		<title>Master Notes Collaboration</title>
		
		<!--version = "1.4";-->
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<link rel="stylesheet" type="text/css" media ="only screen and (min-width: 320px)" href="mobile_chat.css" >
		<link rel="stylesheet" type="text/css" media ="only screen and (min-width: 1280px)" href="main_chat.css" >
		
		<style>
			.view {
				border:0px solid white;
			}
			
			.view2 {
				border: 0px solid red;
			}
			
			textarea#log{
				width:100%;
				height:100%;
			}
			
			.hide{
				display:none;
			}
		</style>
		
	</head>
	
	<body style="font-family:TimesNewRoman!" id="body">

		<script type = "text/javascript">
		
		/////////////////////////////
		//cookies
		/////////////////////////////
		
		function setCookie(cname, cvalue, exdays) { //sets the cookie name, the cookie itself, and the days until expiry
		  var d = new Date(); //makes new date function
		  d.setTime(d.getTime() + (exdays*24*60*60*1000));
		  var expires = "expires="+ d.toUTCString();
		  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}
		
		function getCookie(cname) {
		  var name = cname + "="; //adds the equals symbol because you cant put that in brackets
		  var decodedCookie = decodeURIComponent(document.cookie); //decodes it or something
		  var ca = decodedCookie.split(';'); //splits all cookies (divided by the semicolons)
		  for(var i = 0; i <ca.length; i++) { //repeats as many cookies as there are
			var c = ca[i]; //sets ca to c
			while (c.charAt(0) == ' ') {
			  c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {//if cookie is found 
			  return c.substring(name.length, c.length);//return value of that cookie
			}
		  }
		  return ""; //else return nothing
		}
		
		/////////////////////////////
		//opentab
		/////////////////////////////

			function openTab2()
			{
				console.log('opentab2');
				console.log(this.document.activeElement);
				var el = this.document.activeElement;
				var tabname = el.id;
				

				//declare all variables 
				var tabindex, tabcontent, tablinks;
				
				//finds all tabcontent 
				tabcontent = document.getElementsByClassName("tabcontent");
				//console.log('tabcontent');

				for (tabindex = 0; tabindex < tabcontent.length; tabindex++) {
					tabcontent[tabindex].style.display = "none"; // making it so the tabcontent is not displayed
				}
				
				clearActiveTablinks();
				
				
				// display the tabcontent that is selected
				//document.getElementById(tabname).style.display = "block";  // not sure why this is here... this is what is throwing off the tabs when clicked
				tabcontent[0].style.display = "block";
				//console.log(evt);
				el.className += " active";
				
				document.getElementById(tabname+"Content").style.display = "block"; // I added ids of tabname+"Content" to each tab content to get them to be callable with their tabname
			}   
			
			function clearActiveTablinks()
			{
				// clear active from the tablinks
				tablinks = document.getElementsByClassName("tablinks");
				//console.log('tablinks');
				//console.log(tablinks);
				
				for (tabindex = 0; tabindex < tablinks.length; tabindex++) {
					console.log(tablinks[tabindex].className);
					//tablinks[tabindex].classList.remove("active"); // alternative command
					//console.log('here');
					//console.log(tablinks[tabindex].className.replace("active", ""));
					tablinks[tabindex].className = tablinks[tabindex].className.replace(" active", "");  // this one needs to be assigned back to the element
					
					//tablinks[tabindex].className = "";
				}			
			}
			
			/*
			function getTabIndex(tabName)
			{
				document.getElementBy
			}
			*/
			
			//this part messed it up for some reason
		////to here
		//var ui_chat = document.getElementById("Chat");
		//
		//ui_chat.onclick = function(){
		//	//test();
		//	console.log(ui_chat);
		//	openTab(ui_chat, ui_chat.value);
		//
		//};
		
		/////////////////////////////
		//window.oload
		/////////////////////////////
		
		window.onload = function(){
		
		console.log('load');
		
		
		/////////////////////////////////////////////////////////////////////////
	
		document.getElementById("SectionsContent").style.display = "none";
		document.getElementById("OtherContent").style.display = "none";
	
		////////////////////////////
		//main js
		////////////////////////////
		
		function test()
		{
			console.log('test');
		}
	
		var ui_logout = document.getElementById("logout");
		var ui_login = document.getElementById("login");
		var ui_container = document.getElementById("container");
		var ui_loginSubmit = document.getElementById("loginSubmit");
		
		// if logged_in cookie not set - show log in screen
		var logincookie = getCookie("logged_in");
		check_auth(logincookie);
		
		
		setInterval(function() {
			if(logincookie !=0)
			{
				getChatFromDB();
			}
		}, 60 * 1000); // 60 * 1000 milsec
		
		
		function login_setup(){
			console.log('you are logged in');
			//document.getElementById('container').className = '';
			ui_container.classList.remove("hide");
			
			document.getElementById('login').classList.add("hide");
			document.getElementById('logout').classList.remove("hide");		
		}
		
		function logout(){
			ui_logout.classList.add("hide");
			ui_login.classList.remove("hide");
			ui_container.classList.add("hide");
			document.cookie = "logged_in=0";
		}
		
		function check_auth(apikey){
			console.log('check_auth');
			//var logged_in = getCookie("logged_in");
			var logged_in = apikey;
			//console.log(logged_in);
			//return;
			
			if(logged_in !='bf44550db31d8f59b5da10e3a00a5072a481810b0dadfc6cfcc1f948b5f170f8') // not logged in
			{
				console.log('you are not logged in');
				//alert("incorrect password"); //error msg?
				// show login page
			
				//ui_container.classList.remove('hide');
				ui_container.classList.add('hide');
			}
			else // logged in
			{
				login_setup();

				getChatFromDB();
				
			}
		}
	
	
		
		
		ui_loginSubmit.onclick = function(){
			console.log('you clicked submit');
			
			var user = document.getElementById("loginUser").value;
			var pass = document.getElementById("loginPass").value;
			
			//console.log(pass);
			
			getAuth(user, pass);
			
			//pauseMe();

			//check_auth(logincookie);
			
			
			
		};
		
		 ui_login.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
			console.log('you pressed enter')
		   
		    var user = document.getElementById("loginUser").value;
			var pass = document.getElementById("loginPass").value;
			
			console.log(pass);
			
			getAuth(user, pass);
		  }
		});
		
			async function pauseMe() {
			  await sleep(2000);
			  console.log('MS since start:', Date.now() - start);
			}		
		
		////////////////////////////////////
		// CHAT AREA
		////////////////////////////////////
		
		// when the submit button is hit
		document.getElementById("submit").onclick = function(){
			sendString();
			getChatFromDB();
		}
		
		// when enter is pressed
		var textbox = document.getElementById("textbox");
		
		
		textbox.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
		   event.preventDefault();
		   sendString();
		   //document.getElementById("myBtn").click();
		  }
		});
		
		
		// Logout
		ui_logout.onclick = function(){
			logout();		
		};
		
		function enlargeReload() {
			//document.getElementById("reload").width = "110%";
			var el = document.getElementById("reload");
			console.log(el);
			//el.style.width="12%";
			//el.style.height="7.5%";
			el.style.backgroundColor = "#c2f5ff";
		}
		
//reload		// reload chat
		document.getElementById("reload").onclick = function(){		
			console.log('reload clicked');
			getChatFromDB();
		};
		
		document.getElementById("reload").onmousedown = function() { 
			enlargeReload();	
		} 
		
		document.getElementById("reload").onmouseup = function() {
			document.getElementById("reload").style.backgroundColor = "initial";
		}
		
		document.getElementById("reload").onmouseleave = function () {
			document.getElementById("reload").style.backgroundColor = "initial";
		}
	
		var regexURL = /(?:(?:https?|ftp):\/\/|\b(?:[a-z\d]+\.))(?:(?:[^\s()<>]+|\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))?\))+(?:\((?:[^\s()<>]+|(?:\(?:[^\s()<>]+\)))?\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))?/ig
		var searchURL = '';
		
		function sendString(){	
			console.log('sendstring');
		
			var textbox = document.getElementById("textbox");  // this references the textbox OBJECT
			var savestring = textbox.value; // this is getting the value of the textbox
			
			//console.log(savestring);
			if(savestring!="")
				{
				var username = getCookie("user");
				// the updated save string [user] + savestring
				searchURL = savestring.search(regexURL); //search for all urls in savestring
				
				if (searchURL!="-1") {
					//link
					//savestring.replace(searchURL,); //replace all searchURL (found urls) 
											//   ^ the link needs to go right here
				};	
				savestring = "["+username+"]: " + savestring; 			
				
				console.log("searchurl here");
				console.log(searchURL);
//link finder
				
				// save the chat string
				saveToDB(savestring, getChatFromDB);
				

				// get saved chat to enter into thelog
				// returned_log 
				//getChatFromDB();
				
				
				// update the chat log
				//var thelog = document.getElementById("log");
				
				//console.log('the log 54')
				//console.log(thelog);
				//alert(thelog);
				//console.log(thelog.value);
				

				//console.log(thelog);
				
				// set the textbox to empty
				textbox.value = "";	
				}
			
		}
			
		function saveToDB(savestring, onSuccess) {
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("demo").innerHTML = this.responseText;
			  //console.log(this.responseText);
			  onSuccess();
			}
		  };
		  
		  var apikey = getCookie("logged_in");
		  var poststring = "action=save&savestring=" + savestring + "&apikey=" + apikey;
		  console.log(poststring);
		  xhttp.open("POST", "chat.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		  console.log('saved to db');
		  
		  
		}			
			
		function getChatFromDB() {
		  
		  //isStillOnline()
			
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("log").innerHTML = this.responseText; // this.responseText should be from python
			  //console.log(this.responseText);
			  var responses = JSON.parse(this.responseText);
			  console.log('js responses: ');
			  console.log(responses);
			  //console.log(typeof(responses));
			  //console.log(responses[0][0]);
			  //responses.forEach()
			  
			  var formatted_chatlog = '';
			  var compiled_chatlog = '';
			  var mentions = '';
			  var You = document.getElementById("loginUser").value;
			  var mentionRegex = /\@/g;
			  
			  for(i=0; i<responses.length; i++)
			  {
				//console.log(responses[i]["ID"]);
				formatted_chatlog = formatted_chatlog + responses[i]["date"] + " " + responses[i]["chatstring"] + "\n";
				compiled_chatlog = formatted_chatlog;
				mentions = compiled_chatlog.search(mentionRegex+You);
				console.log(mentions);
				if (mentions > 0) {
					mentions.classList.add("mention");
				}
				
			  }
			  
			  var ui_log = document.getElementById("log");
			  ui_log.innerHTML = formatted_chatlog; // this.responseText should be from python
			  
			  ui_log.scrollTop = ui_log.scrollHeight; // this allows for the scrolling to the bottom of the textarea
			  
			}
		  };
		  
		  //console.log(getCookie("logged_in"));
		  var poststring = "action=getchat&apikey=" + getCookie("logged_in");
		  //console.log(poststring);
		  xhttp.open("POST", "chat.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		}	
			
		function getAuth(user, pass) {
			console.log('getAuth');
		
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				// what to do if this request works
				
			  //console.log(this.responseText);
			  var responses = JSON.parse(this.responseText); //  use if response is json
			  //var responses = this.responseText;
			  
			  //console.log('js responses: ');
			  //console.log(responses);
			  //console.log(typeof(responses));
			  //console.log(responses[0][0]);
			  //responses.forEach()
			  
			// set cookie
			document.cookie = 'logged_in=' + responses.apikey;
			document.cookie = 'user=' + responses.user;
			//console.log(document.cookie);
			
			//document.cookie = "expires=Thu, 01 Jan 1970 00:00:00 UTC;";
			
			//console.log(document.cookie);
			
			var logged_in = getCookie("logged_in");
			check_auth(responses.apikey);
			
			// change hide settings
			
			// load chat
			
			
			// to streamline, make this into a callable function
			  
			}
		
		  };
		  
		  var poststring = "user=" + user + "&pass=" + pass;
		  console.log(poststring);
		  xhttp.open("POST", "auth.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		 
		}	
		
		// if any radio buttons are pressed
		document.getElementById("modeDefault").addEventListener("change", set_mode);
		document.getElementById("modeDark").addEventListener("change", set_mode);
		document.getElementById("modeMo").addEventListener("change", set_mode);
		
		// find which one is pressed/active
		
		function tell_me_the_mode() { 
		
            var ele = document.getElementsByName('mode'); 
              
            for(i = 0; i < ele.length; i++) { 
                if(ele[i].checked) 
				{
					var mode = ele[i].id;

				}
            } 
			
			return mode;
			//console.log(mode);
        } 
		
		// set the body class to the appropriate mode

		//let previousMode = ["body",];
		var previousMode2 = "body";
		
		function setPreferredMode() {
			var currentMode = tell_me_the_mode();
			console.log("below is active element");
			console.log(currentMode);
			setCookie("mode",currentMode,365) //sets cookie
		}
		
		function checkPreferredMode() {
			var preferredMode = getCookie("mode")//finds mode
			console.log(preferredMode);
			
			if (preferredMode != "") { //if not empty
				//alert("your preferred mode is "+preferredMode);
				//console.log("here");
				//console.log(preferredMode);
				document.getElementById(preferredMode).checked = true;//set mode to preferredMode
			}else{
				//alert("no cookie found");
				setCookie("mode","body",365)
				//set mode to body
			}
		}
		
		function set_mode()
		{	
			console.log("previousMode2 below");
			console.log(previousMode2);
			
			var mode = tell_me_the_mode();
			
			if(mode=="modeDark")
			{
				var modeClass = "dark";
			}
			
			if(mode=="modeMo")
			{
				var modeClass = "mo";
			}

			if(mode=="modeDefault")
			{
				var modeClass = "body";
			}			
			
			setPreferredMode();
			
			var ele = [
			"body",
			"log",
			"Sections",
			"Chat",
			"Other",
			"textbox",
			"submit",
			"vHist",
			"logout",
			];
		
			var eleLength = ele.length
			//console.log(eleLength);
			
			//remove class name from body
//////////////////////////////////////////////////////////////////////////////
			//var eleBody = document.getElementById(ele);
			
			//ele.className = '';
			//eleLog.className = '';
						
			var loopClassName;
			
			for (loopClassName = 0; loopClassName < eleLength; loopClassName++) {  //adding mode to ele array
			  //ele[loopClassName].className = '';
			  var eleClass = document.getElementById(ele[loopClassName]);
			  //console.log(typeof(eleClass));
			  
			  //var currentIndex = previousMode[];
			  //console.log(currentIndex);
			  var modeClassReplaced = eleClass.classList.remove(previousMode2);
			  //eleClass.className = modeClassReplaced;
			  
			  //eleClass.className = 'tablinks ';
			  eleClass.classList.add(modeClass);
			  
			  //console.log(eleClass.classList);
			}
			previousMode2 = modeClass;
			//add class name to body
			
			//eleBody.classList.add(modeClass);
			//eleLog.classList.add(modeClass);
			
			//var loopClassList;
			
			/*
			for (loopClassList = 0; loopClassList < 6; loopClassList++) {
			  //ele[loopClassList].classList.add(modeClass);
			  document.getElementById(ele[loopClassList]).add(modeClass);
			}
			*/
			
			//console.log(mode);
			//document.getElementById.
			
			
		}
			
		checkPreferredMode();
		set_mode();
		
		function testApi()
		{
		var xhttp = new XMLHttpRequest();
		
		// run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("demo").innerHTML = this.responseText;
			  //console.log('api response: ');
			  //console.log(this.responseText);
			  //onSuccess();
			}
		  };
		  
		  var poststring = "action=save&savestring=" + 'this is a test' + '&apikey=12';
		  xhttp.open("POST", "chat.php", true); // post
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring); // post
		  
		  
		  /*
		  xhttp.open("GET", "chat.php?action=test", true);
		  xhttp.send();
		  console.log('saved to db');
		  */
		  
		}

		}
		</script>
	
		<div id="container" class="hide" style="position:relative;"> <!--this is the main page-->
			
			
			<div id="mainpg" class="view">
						<h1 title="this site was made by reese" id="titleMNCW">Master Notes Collaboration</h1>
						
						<p id="changelogLink"><a href="https://tinyurl.com/y5l9tpda" target="_blank" id="vHist">MNCW Version 1.4</a></p>
						<hr>
					
					<div class="tabcontent view2"> <!-- Top banner -->
						
						<!--tablinks / button that go to each page-->
							<input type="button" class="tablinks active" onclick="openTab2()" id="Chat" value=Chat>
							<input type="button" class="tablinks" onclick="openTab2()" 	id="Sections" value=Sections>
							<input type="button" class="tablinks" onclick="openTab2()" 	id="Other" value=Other>	
										<!--reload button-->
							<input type="image" class="view2" id="reload" width="100%" height="100%" src="Assets/reload.svg" />				

			
					</div>
			
				
				<!--chat content-->
				<div class="tabcontent" id="ChatContent">
					<!--who's online-->
					<div class="view" id="memberList"> 
								<h2>Online</h1>	
								
								<p title="why hello there">reese</p>
								<p>neha</p>
								<p>mo</p>
								<p>lee</p>
					</div>		
					
					<!--actual chat part-->
					<div style="width:84%; float:left;">
						<textarea id="log" name="chatlog" readonly style="left:400;top:279;height:50%;"></textarea>
					</div>
					
					<input type="text" id="textbox" class="form" name="textbox" placeholder="Type something..."  style="height:29;width:84.9%"/>
					<input type="submit" id="submit" style="font-size:20;width:15%;float:right;"/>	
					
				</div>
				
				<div class="tabcontent" id="SectionsContent"> <!--sections pg-->
					<p>Roses are red, Avatar you should binge,</p>
					<p>Korra is okay, this poem is cringe...</p>

				</div>
				
				<div class="tabcontent" id="OtherContent">
					<p>your daily dose of emoji</p>	
					
					<div>
						<pre style="font-size:300%">&nbsp;&#128512;&nbsp;&#128514;&nbsp;&#128531;&nbsp;&#128520;&nbsp;&#128539;&nbsp;&#128557;&nbsp;&#128534;&nbsp;&#128526;&nbsp;&#128567;&nbsp;&#127875;</pre>
					</div>
					<a href="https://invite.duolingo.com/BDHTZTB5CWWKTXIDI7IOHXECIE">Use my Duolingo referral link</a> <br><br>
					<small>FYI the symbols and(&) plus(+) and quotations ("") are not usable in the chat.</small>
				</div>
						
				
			</div>
		
		</div>
		
			<!--underneath is the login page, hidden upon login-->
			<div class="loginpg" id="login">
				<div>
					<p>master notes collaboration website</p>
				</div>
					
						<p style="font-size:200%;">username:<input id="loginUser" class="loginInput" type=text></p>
						<p style="font-size:200%;">password:<input id="loginPass" class="loginInput" type=password></p>
						<button id="loginSubmit" style="">submit</button>
					
			</div>
		
		<div class=view2 id="controlBox"> <!--Modes + Logout-->
				<label class="radioButton"><input type="radio" name="mode" id="modeDefault" checked value="Default mode">Default mode</label><br>
				<label class="radioButton"><input type="radio" name="mode" id="modeDark" value="Dark mode">Dark mode</label><br>
				<label class="radioButton"><input type="radio" name="mode" id="modeMo" value="Mo(de)">Mo(de)<label><br>
			
				<button id="logout">Logout</button>
		</div>
