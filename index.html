<html>
	<head>
		<title>Master Notes Collaboration</title>
		
		<!version = "11.7";>
		
		<link rel="stylesheet" href="MNC_chat.css">
		
		<style>
			.view {
				border:0px solid white;
			}
			
			textarea#log{
				width:100%;
				height:100%;
			}
			
			.hide{
				display:none;
			}
		</style>
		
	</head>
	
	<body style="font-family:TimesNewRoman!" id="body">

		<script>
		window.onload = function(){
		
		//
	
		var ui_logout = document.getElementById("logout");
		var ui_login = document.getElementById("login");
		var ui_container = document.getElementById("container");
		var ui_loginSubmit = document.getElementById("loginSubmit");
		
		// if logged_in cookie not set - show log in screen
		var logincookie = getCookie("logged_in");
		check_auth(logincookie);
		
		
		setInterval(function() {
			if(logincookie !=0)
			{
				getChatFromDB();
			}
		}, 60 * 1000); // 60 * 1000 milsec
		
		
		function login_setup(){
			console.log('you are logged in');
			//document.getElementById('container').className = '';
			ui_container.classList.remove("hide");
			
			document.getElementById('login').classList.add("hide");
			document.getElementById('logout').classList.remove("hide");		
		}
		
		function logout(){
			ui_logout.classList.add("hide");
			ui_login.classList.remove("hide");
			ui_container.classList.add("hide");
			document.cookie = "logged_in=0";
		}
		
		function check_auth(apikey){
			console.log('check_auth');
			//var logged_in = getCookie("logged_in");
			var logged_in = apikey;
			//console.log(logged_in);
			//return;
			
			if(logged_in !='bf44550db31d8f59b5da10e3a00a5072a481810b0dadfc6cfcc1f948b5f170f8') // not logged in
			{
				console.log('you are not logged in');
				//alert("incorrect password"); //error msg?
				// show login page
			
				//ui_container.classList.remove('hide');
				ui_container.classList.add('hide');
			}
			else // logged in
			{
				login_setup();

				getChatFromDB();
				
			}
		}
	
	
		
		
		ui_loginSubmit.onclick = function(){
			console.log('you clicked submit');
			
			var user = document.getElementById("loginUser").value;
			var pass = document.getElementById("loginPass").value;
			
			//console.log(pass);
			
			getAuth(user, pass);
			
			//pauseMe();

			//check_auth(logincookie);
			
			
			
		};
		
		 ui_login.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
			console.log('you pressed enter')
		   
		    var user = document.getElementById("loginUser").value;
			var pass = document.getElementById("loginPass").value;
			
			console.log(pass);
			
			getAuth(user, pass);
		  }
		});
		
			async function pauseMe() {
			  await sleep(2000);
			  console.log('MS since start:', Date.now() - start);
			}		
		
		////////////////////////////////////
		// CHAT AREA
		////////////////////////////////////
		
		// when the submit button is hit
		document.getElementById("submit").onclick = function(){
			sendString();
			getChatFromDB();
		}
		
		// when enter is pressed
		var textbox = document.getElementById("textbox");
		
		
		textbox.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
		   event.preventDefault();
		   sendString();
		   //document.getElementById("myBtn").click();
		  }
		});
		
		
		// Logout
		ui_logout.onclick = function(){
			logout();		
		};
		
		
		// reload chat
		document.getElementById("reload").onclick = function(){		
			console.log('reload clicked');
			getChatFromDB();
		};
	
		
		function sendString(){	
			console.log('sendstring');
		
			var textbox = document.getElementById("textbox");  // this references the textbox OBJECT
			var savestring = textbox.value; // this is getting the value of the textbox
			
			//console.log(savestring);
			if(savestring!="")
				{
				var username = getCookie("user");
				// the updated save string [user] + savestring
				savestring = "["+username+"]: " + savestring; 
				
				// save the chat string
				saveToDB(savestring, getChatFromDB);
				

				// get saved chat to enter into thelog
				// returned_log 
				//getChatFromDB();
				
				
				// update the chat log
				//var thelog = document.getElementById("log");
				
				//console.log('the log 54')
				//console.log(thelog);
				//alert(thelog);
				//console.log(thelog.value);
				

				//console.log(thelog);
				
				// set the textbox to empty
				textbox.value = "";	
				}
			
		}
			
		function saveToDB(savestring, onSuccess) {
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("demo").innerHTML = this.responseText;
			  //console.log(this.responseText);
			  onSuccess();
			}
		  };
		  
		  var apikey = getCookie("logged_in");
		  var poststring = "action=save&savestring=" + savestring + "&apikey=" + apikey;
		  console.log(poststring);
		  xhttp.open("POST", "chat.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		  console.log('saved to db');
		  
		  
		}			
			
		function getChatFromDB() {
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("log").innerHTML = this.responseText; // this.responseText should be from python
			  //console.log(this.responseText);
			  var responses = JSON.parse(this.responseText);
			  console.log('js responses: ');
			  console.log(responses);
			  //console.log(typeof(responses));
			  //console.log(responses[0][0]);
			  //responses.forEach()
			  
			  var formatted_chatlog = '';
			  
			  for(i=0; i<responses.length; i++)
			  {
				//console.log(responses[i]["ID"]);
				formatted_chatlog = formatted_chatlog + responses[i]["date"] + " " + responses[i]["chatstring"] + "\n";
				
			  }
			  
			  var ui_log = document.getElementById("log");
			  ui_log.innerHTML = formatted_chatlog; // this.responseText should be from python
			  
			  ui_log.scrollTop = ui_log.scrollHeight; // this allows for the scrolling to the bottom of the textara
			  
			}
		  };
		  
		  //console.log(getCookie("logged_in"));
		  var poststring = "action=getchat&apikey=" + getCookie("logged_in");
		  //console.log(poststring);
		  xhttp.open("POST", "chat.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		}	
			
		function getAuth(user, pass) {
			console.log('getAuth');
		
		  var xhttp = new XMLHttpRequest();
		  
		  // run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				// what to do if this request works
				
			  //console.log(this.responseText);
			  var responses = JSON.parse(this.responseText); //  use if response is json
			  //var responses = this.responseText;
			  
			  //console.log('js responses: ');
			  //console.log(responses);
			  //console.log(typeof(responses));
			  //console.log(responses[0][0]);
			  //responses.forEach()
			  
			// set cookie
			document.cookie = 'logged_in=' + responses.apikey;
			document.cookie = 'user=' + responses.user;
			//console.log(document.cookie);
			
			//document.cookie = "expires=Thu, 01 Jan 1970 00:00:00 UTC;";
			
			//console.log(document.cookie);
			
			var logged_in = getCookie("logged_in");
			check_auth(responses.apikey);
			
			// change hide settings
			
			// load chat
			
			
			// to streamline, make this into a callable function
			  
			}
		
		  };
		  
		  var poststring = "user=" + user + "&pass=" + pass;
		  console.log(poststring);
		  xhttp.open("POST", "auth.php", true);
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring);
		 
		}	
		
		// if any radio buttons are pressed
		document.getElementById("modeDefault").addEventListener("change", set_mode);
		document.getElementById("modeDark").addEventListener("change", set_mode);
		document.getElementById("modeMo").addEventListener("change", set_mode);
		
		// find which one is pressed/active
		
		function tell_me_the_mode() { 
            var ele = document.getElementsByName('mode'); 
              
            for(i = 0; i < ele.length; i++) { 
                if(ele[i].checked) 
				{
					var mode = ele[i].id;

				}
            } 
			
			return mode;
			//console.log(mode);
        } 
		
		// set the body class to the appropriate mode

	
		function set_mode()
		{	
			var mode = tell_me_the_mode();
			
			if(mode=="modeDark")
			{
				var modeClass = "dark";
			}
			
			if(mode=="modeMo")
			{
				var modeClass = "mo";
			}

			if(mode=="modeDefault")
			{
				var modeClass = "body";
			}			
			
			var ele = [
			"body",
			"log",
			"Status",
			"Chat",
			"Profile",
			"textbox",
			"submit",
			"vHist",
			];
		
			var eleLength = ele.length
			//console.log(eleLength);
			
			//remove class name from body
//////////////////////////////////////////////////////////////////////////////
			//var eleBody = document.getElementById(ele);
			
			//ele.className = '';
			//eleLog.className = '';
						
			var loopClassName;
			
			for (loopClassName = 0; loopClassName < eleLength; loopClassName++) {
			  //ele[loopClassName].className = '';
			  var eleClass = document.getElementById(ele[loopClassName]);
			  //console.log(typeof(eleClass));
			  eleClass.className = '';
			  eleClass.classList.add(modeClass);
			  
			  //console.log(eleClass.classList);
			}
			//add class name to body
			
			//eleBody.classList.add(modeClass);
			//eleLog.classList.add(modeClass);
			
			//var loopClassList;
			
			/*
			for (loopClassList = 0; loopClassList < 6; loopClassList++) {
			  //ele[loopClassList].classList.add(modeClass);
			  document.getElementById(ele[loopClassList]).add(modeClass);
			}
			*/
			
			//console.log(mode);
			//document.getElementById.

			
			
			
		}
		
		function testApi()
		{
		var xhttp = new XMLHttpRequest();
		
		// run this when the readstate changes
		  xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  //document.getElementById("demo").innerHTML = this.responseText;
			  //console.log('api response: ');
			  //console.log(this.responseText);
			  //onSuccess();
			}
		  };
		  
		  var poststring = "action=save&savestring=" + 'this is a test' + '&apikey=12';
		  xhttp.open("POST", "chat.php", true); // post
		  xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); // php seems to need this
		  xhttp.send(poststring); // post
		  
		  
		  /*
		  xhttp.open("GET", "chat.php?action=test", true);
		  xhttp.send();
		  console.log('saved to db');
		  */
		  
		}
		
		function getCookie(cname) {
			  var name = cname + "=";
			  var decodedCookie = decodeURIComponent(document.cookie);
			  var ca = decodedCookie.split(';');
			  for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
				  c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
				  return c.substring(name.length, c.length);
				}
			  }
			  return "";
			}
		}
		</script>
		<div id="container" class="hide">
		
					<div style="width:60%; margin-left:20%" class="view">
					<h1 style="text-align:center;font-size:75" title="this site was made by reese">Master Notes Collaboration</h1>
					
					<p style="font-size:24;text-align:center;"><a href="https://tinyurl.com/yawp86zd" id="vHist">MNC Version 11.7</a></p>
					<hr>
				<div class=view >
					<input type="button" id="Status" style="font-size:20;height:75;width:23%;"value=Status>
					<input type="button" id="Chat" style="font-size:20;height:75;width:23%;"value=Chat>
					<input type="button" id="Profile" style="font-size:20;height:75;width:23%;"value=Profile>	
					<div style="width:25%;display:inline;float:right;height:75" class=view>	
						<input type="image" id="reload" width="100%" height="100%" src="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9JzMwMHB4JyB3aWR0aD0nMzAwcHgnICBmaWxsPSIjMDAwMDAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWw6c3BhY2U9InByZXNlcnZlIiB2ZXJzaW9uPSIxLjEiIHN0eWxlPSJzaGFwZS1yZW5kZXJpbmc6Z2VvbWV0cmljUHJlY2lzaW9uO3RleHQtcmVuZGVyaW5nOmdlb21ldHJpY1ByZWNpc2lvbjtpbWFnZS1yZW5kZXJpbmc6b3B0aW1pemVRdWFsaXR5OyIgdmlld0JveD0iMCAwIDEwMDAwMCAxMDAwMDAiIHg9IjBweCIgeT0iMHB4IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCI+PGRlZnM+PHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAgCiAgICAuZmlsMCB7ZmlsbDojMDAwMDAwO2ZpbGwtcnVsZTpub256ZXJvfQogICAKICA8L3N0eWxlPjwvZGVmcz48Zz48cGF0aCBjbGFzcz0iZmlsMCIgZD0iTTQ1MjQwIDE0NzE4YzE0OTc3LDAgMjc4MDYsOTM4NyAzMjkxNSwyMjU4NGwxMTg4OCAwIC04NzIyIDkwODEgLTg3MjMgOTA3OCAtODcyMiAtOTA4MSAtODcyMiAtOTA3OCAxMTUxNyAwYy00MzMxLC03MzExIC0xMjI5NiwtMTIxOTcgLTIxNDMxLC0xMjE5NyAtMTM3NjMsMCAtMjQ4OTUsMTExMzAgLTI0ODk1LDI0ODk1IDAsMTM3NTEgMTExNDMsMjQ4OTQgMjQ4OTUsMjQ4OTQgOTE1NCwwIDE3MTQyLC00OTIzIDIxNDY2LC0xMjI3MGwxMTQ4MSAwYy01MDg2LDEzMjQxIC0xNzkzMSwyMjY1NyAtMzI5NDcsMjI2NTcgLTE5NDgwLDAgLTM1MjgyLC0xNTgwMiAtMzUyODIsLTM1MjgxIDAsLTE5NDY1IDE1ODE2LC0zNTI4MiAzNTI4MiwtMzUyODJ6Ij48L3BhdGg+PC9nPjwvc3ZnPg" />				
					</div>
					
				</div>
					
				<div class=view>	
					<textarea id="log" name="chatlog" readonly style="left:400;top:279;height:50%;"></textarea>
					<input type="text" id="textbox" class="form" name="textbox" placeholder="Type something..."  style="height:29;width:84.9%"/>
					<input type="submit" id="submit" style="font-size:20;width:15%;float:right;"/>						
				</div>
			</div>	
			
		</div>
		

			<div id="login" class=loginpg style="text-align:center;margin:0 auto;width:27%;margin-top:5%;border:2px solid #d1d1d1; border-radius: 30px; background-color:White;padding-bottom:15px;">
				<div>
					<p>master notes collaboration v11</p>
				</div>
					
						<p style="font-size:200%;">username:<input id="loginUser" type=text style="font-size: 20px;color:SlateGray;border: 2px solid #d1d1d1;border-radius: 5px;"></p>
						<p style="font-size:200%;">password:<input id="loginPass" type=password style="font-size: 20px;color:SlateGray;border: 2px solid #d1d1d1;border-radius: 5px;"></p>
						<button id="loginSubmit" style="font-size:120%;margin-left:67%;font-family:verdana;color:DarkGray;background-color:GhostWhite;border: 2px solid #d1d1d1; border-radius: 5px;">submit</button>
					
			</div>
		
		<div>
			<label><input type="radio" name="mode" id="modeDefault" checked value="Default mode">Default mode</label><br>
			<label><input type="radio" name="mode" id="modeDark" value="Dark mode">Dark mode</label><br>
			<label><input type="radio" name="mode" id="modeMo" value="Mo(de)">Mo(de)<label><br>
			<br>
		</div>
		
		
		<div id="logout">
			<button id="logout">Logout</button>
		</div>
			
